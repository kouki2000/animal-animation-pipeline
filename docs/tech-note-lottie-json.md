# 📝 技術ノート：Lottie JSON 構造理解

> Month 0 Week 3 作成  
> 目的：PythonでLottie互換JSONを自動生成するために構造を把握する

---

## 1. Lottie とは何か

- アニメーションを **JSON で表現するフォーマット**
- もともとは Airbnb が開発した After Effects → モバイル向けライブラリ
- Flutter でも `lottie` パッケージで再生できる
- GIFと違い **ベクター形式** なのでどんなサイズでも綺麗

**このプロジェクトでの位置づけ：**

```
Python がポーズ推定した座標データ → Lottie JSON に変換 → Flutter で再生
```

つまり After Effects を使わず、**Python が直接 JSON を生成する**のがゴール。

---

## 2. Lottie JSON の全体構造

```json
{
  "v": "5.7.4",       // Lottieのバージョン
  "fr": 60,           // フレームレート（fps）
  "ip": 0,            // アニメーション開始フレーム
  "op": 60,           // アニメーション終了フレーム（= 1秒分）
  "w": 500,           // 横幅（px）
  "h": 500,           // 縦幅（px）
  "layers": [ ... ],  // ★ レイヤーの配列（メイン）
  "assets": [ ... ]   // 画像などの外部リソース（今回は基本不要）
}
```

**重要な4つのキー：**

| キー | 意味 | このプロジェクトでの値 |
|------|------|----------------------|
| `fr` | フレームレート | 60（Month 1のゴール） |
| `ip` / `op` | 開始・終了フレーム | 0 〜 60（1秒ループ） |
| `layers` | 描画するもの全部 | 関節・骨格ライン |
| `assets` | 外部リソース | 基本的に使わない |

---

## 3. layers（レイヤー）の構造

レイヤー = 画面に描画する「部品」の単位。

```json
{
  "ty": 4,           // レイヤーの種類（4 = シェイプレイヤー）
  "nm": "左前脚",    // レイヤー名（デバッグ用）
  "ip": 0,           // このレイヤーの開始フレーム
  "op": 60,          // このレイヤーの終了フレーム
  "ks": { ... },     // トランスフォーム（位置・回転・スケール）
  "shapes": [ ... ]  // ★ このレイヤーの形状データ
}
```

**レイヤーの種類（ty の値）：**

| ty | 種類 | 用途 |
|----|------|------|
| 0 | Composition | 別のアニメーションを入れ子にする |
| 1 | Solid | 単色の四角形 |
| 4 | Shape | ★ 線・円・パスなどベクター形状（今回メイン） |

---

## 4. shapes（シェイプ）の構造

shapes = レイヤー内の実際の「絵」の定義。

```json
{
  "ty": "el",        // シェイプの種類（el = 楕円）
  "p": {             // 位置（関節の座標）
    "a": 1,          // アニメーションあり（1）か静止（0）か
    "k": [           // キーフレームの配列
      {
        "t": 0,      // フレーム番号
        "s": [250, 100]  // このフレームでのXY座標
      },
      {
        "t": 30,
        "s": [260, 110]
      }
    ]
  },
  "s": { "a": 0, "k": [20, 20] }  // サイズ（静止・20x20px）
}
```

**シェイプの種類（ty の値）：**

| ty | 種類 | このプロジェクトでの用途 |
|----|------|------------------------|
| `el` | 楕円 | 関節の点を表示 |
| `sh` | パス | 骨格の線（関節間） |
| `fl` | 塗りつぶし | 関節・線の色 |
| `st` | 線のスタイル | 骨格ラインの太さ・色 |

---

## 5. keyframes（キーフレーム）の仕組み

キーフレーム = 「フレームNの時点での値」の記録。

```
フレーム 0:  鼻の座標 [250, 80]
フレーム 15: 鼻の座標 [255, 85]
フレーム 30: 鼻の座標 [250, 80]  ← ループ
```

Lottie はキーフレーム間を **自動補間** して滑らかにアニメーションさせる。

**アニメーションあり（`a: 1`）の場合：**

```json
"k": [
  { "t": 0,  "s": [250, 80], "e": [255, 85] },
  { "t": 15, "s": [255, 85], "e": [250, 80] },
  { "t": 30, "s": [250, 80] }
]
```

**静止（`a: 0`）の場合：**

```json
"k": [250, 80]   // シンプルに値だけ
```

---

## 6. このプロジェクトでの JSON 生成方針

MediaPipe が出力する座標データをそのままキーフレームに変換する。

```
MediaPipe 出力:
  frame_0: { nose: [250,80], left_shoulder: [230,150], ... }
  frame_1: { nose: [251,81], left_shoulder: [231,151], ... }
  ...

↓ Python で変換

Lottie JSON:
  layers[0] (nose):
    shapes.p.k = [ {t:0, s:[250,80]}, {t:1, s:[251,81]}, ... ]
  layers[1] (left_shoulder):
    shapes.p.k = [ {t:0, s:[230,150]}, {t:1, s:[231,151]}, ... ]
```

---

## 7. 重要なポイント・注意点

- `a: 0` / `a: 1` の切り替えを間違えると値が読まれない
- フレームレート（`fr`）と座標のフレーム番号（`t`）は一致させること
- ファイルサイズはキーフレーム数に比例して大きくなる
  → 全フレームをキーフレームにすると重くなるので、将来的に間引きを検討
- `layers` の順番が描画順（後のレイヤーが前面）

---

## 8. 参考リンク

- [Lottie Docs（公式）](https://lottiefiles.github.io/lottie-docs/)
- [Flutter lottie パッケージ](https://pub.dev/packages/lottie)
- [Lottie JSON サンプル（GitHub）](https://github.com/airbnb/lottie-web/tree/master/docs/json)

---

*作成: Month 0 Week 3 / 次に読むタイミング: Month 2（関節実装前）*
